<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>FogFit</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
<style>
  :root { --maxw: 1000px; }
  body {
    font-family: system-ui,-apple-system;
    margin: 2rem;
    display: flex;
    gap: 2rem;
    justify-content: center;
    background: url("/static/img/fog.jpg") no-repeat center center fixed;
    background-size: cover;
    color: #fff;
  }
  .wrap { width: 100%; max-width: var(--maxw); backdrop-filter: blur(10px); background: rgba(0,0,0,0.35); border-radius: 16px; padding: 2rem; }
  #map { width: 100%; height: 520px; border:1px solid rgba(255,255,255,.2); border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.4); margin:1rem 0 }
  .two-col {display:grid; grid-template-columns: 1fr 320px; gap:1.5rem;}
  @media (max-width: 900px){ .two-col{grid-template-columns: 1fr;} }
  .panel{border:1px solid rgba(255,255,255,.3);border-radius:12px;padding:1rem;background:rgba(0,0,0,.3)}
  h1 {margin:0 0 .25rem 0}
  p.sub{color:#ddd;margin:.25rem 0 1rem}
  a.btn{display:inline-block;padding:.45rem .7rem;border:1px solid #eee;border-radius:8px;margin:.25rem 0;text-decoration:none;color:#fff}
  a.btn:hover{background:rgba(255,255,255,.1)}
  .list{max-height:460px;overflow:auto}
  input[type="search"]{width:100%;padding:.5rem .7rem;border:1px solid #ccc;border-radius:8px;margin-bottom:.6rem}
  .music{position:sticky;top:0;display:flex;gap:.5rem;align-items:center;background:rgba(0,0,0,.5);padding:.5rem .75rem;border:1px solid rgba(255,255,255,.3);border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.4);width:max-content}
  .music button{border:1px solid #eee;border-radius:8px;padding:.35rem .6rem;background:rgba(255,255,255,.1);color:#fff;cursor:pointer}
  .music small{color:#ddd;}
</style>
</head>
<body>
  <div class="wrap">
    <h1>FogFit</h1>
    <p class="sub">Click a pin on the map or pick from the list to get a micro-climate outfit suggestion.</p>

    <!-- music controls -->
    <div class="music" aria-live="polite">
      <button id="musicToggle" type="button">▶︎ Play</button>
      <small id="musicStatus">“I Left My Heart in San Francisco”</small>
      <audio id="bgm" src="/static/audio/bgm.mp3" loop preload="auto"></audio>
    </div>

    <div class="two-col">
      <div>
        <div id="map" role="region" aria-label="San Francisco map"></div>
      </div>

      <div class="panel">
        <input id="filter" type="search" placeholder="Filter neighborhoods…">
        <div class="list">
          <ul id="hood-list">
            {% for n in neighborhoods|sort %}
              <li><a class="btn" href="/recommend/{{ n|urlencode }}">{{ n }}</a></li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // points from FastAPI
    const POINTS = {{ points|tojson }};

    // Map centered on SF
    const map = L.map('map', { zoomControl: true }).setView([37.76, -122.445], 12);

    // OSM tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Markers (click → recommend)
    POINTS.forEach(p => {
      const m = L.marker([p.lat, p.lon]).addTo(map);
      m.on('click', () => {
        window.location.href = '/recommend/' + encodeURIComponent(p.name);
      });
      m.bindPopup(`<strong>${p.name}</strong><br/><a href="/recommend/${encodeURIComponent(p.name)}">Get outfit →</a>`);
    });

    // Filter list
    const filter = document.getElementById('filter');
    const list = document.getElementById('hood-list');
    filter.addEventListener('input', () => {
      const q = filter.value.toLowerCase();
      [...list.querySelectorAll('li')].forEach(li => {
        const text = li.textContent.toLowerCase();
        li.style.display = text.includes(q) ? '' : 'none';
      });
    });

    // ====== Music logic ======
    const bgm = document.getElementById('bgm');
    const toggle = document.getElementById('musicToggle');
    const status = document.getElementById('musicStatus');

    function setBtn(playing){
      toggle.textContent = playing ? "❚❚ Pause" : "▶︎ Play";
    }

    // Click to play/pause
    toggle.addEventListener('click', async () => {
      try {
        if (bgm.paused) {
          await bgm.play();
          setBtn(true);
        } else {
          bgm.pause();
          setBtn(false);
        }
      } catch (e) {
        console.log('Audio error:', e);
      }
    });

    // Try to auto-play after first interaction anywhere on the page
    const resumeOnce = () => {
      document.removeEventListener('pointerdown', resumeOnce);
      bgm.play().then(() => setBtn(true)).catch(() => setBtn(false));
    };
    document.addEventListener('pointerdown', resumeOnce);

    // Also try immediate autoplay (some browsers allow if the user recently interacted)
    bgm.play().then(() => setBtn(true)).catch(() => setBtn(false));
  </script>
</body>
</html>
